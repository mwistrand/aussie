# Aussie Gateway Configuration

# Forwarding headers (RFC 7239 by default)
aussie.gateway.forwarding.use-rfc7239=true

# Request size limits
aussie.gateway.limits.max-body-size=10485760
aussie.gateway.limits.max-header-size=8192
aussie.gateway.limits.max-total-headers-size=32768

# Global access control for private endpoints (uncomment and configure as needed)
# aussie.gateway.access-control.allowed-ips=10.0.0.0/8,192.168.0.0/16,127.0.0.1
# aussie.gateway.access-control.allowed-domains=internal.example.com
# aussie.gateway.access-control.allowed-subdomains=*.internal.example.com

# =============================================================================
# Storage Configuration
# =============================================================================

# Repository provider selection
# Options: memory (default, non-persistent), cassandra
# Default uses highest priority available provider
# aussie.storage.repository.provider=cassandra

# =============================================================================
# Cache Configuration (Optional)
# =============================================================================

# Enable caching (requires Redis to be available)
aussie.storage.cache.enabled=false

# Cache provider selection (only used if cache.enabled=true)
# Options: redis
# aussie.storage.cache.provider=redis

# Cache TTL in ISO-8601 duration format
aussie.storage.cache.ttl=PT15M

# =============================================================================
# Cassandra Configuration
# =============================================================================

# Contact points (comma-separated host:port pairs)
aussie.storage.cassandra.contact-points=${CASSANDRA_CONTACT_POINTS:cassandra:9042}

# Local datacenter name
aussie.storage.cassandra.datacenter=datacenter1

# Keyspace name
aussie.storage.cassandra.keyspace=aussie

# Run database migrations on startup (default: false)
# When enabled, applies any pending CQL migrations from db/cassandra/
aussie.storage.cassandra.run-migrations=${CASSANDRA_RUN_MIGRATIONS:false}

# Authentication (uncomment for production)
# aussie.storage.cassandra.username=${CASSANDRA_USERNAME}
# aussie.storage.cassandra.password=${CASSANDRA_PASSWORD}

# =============================================================================
# Quarkus Redis Configuration
# =============================================================================

quarkus.redis.hosts=redis://localhost:6379

# Authentication (uncomment for production)
# quarkus.redis.password=${REDIS_PASSWORD}

# Health check - disabled by default (enable when Redis is available)
quarkus.redis.health.enabled=false

# =============================================================================
# Authentication Configuration
# =============================================================================

# Enable/disable authentication (default: true)
aussie.auth.enabled=true

# Only require auth for admin paths (default: true)
# When true, /admin/* requires authentication but /gateway/* and /{serviceId}/* remain open
aussie.auth.admin-paths-only=true

# DANGEROUS: Disable authentication entirely for development
# WARNING: Never enable this in production!
aussie.auth.dangerous-noop=false

# JWT authentication (for OAuth2/OIDC setups)
# Uncomment and configure for JWT support
# aussie.auth.jwt.issuer=https://auth.example.com
# aussie.auth.jwt.audience=aussie-api
# aussie.auth.jwt.jwks-uri=https://auth.example.com/.well-known/jwks.json

# =============================================================================
# Quarkus Security Path Permissions
# =============================================================================

# Admin endpoints require authentication (enforced by @RolesAllowed on endpoints)
quarkus.http.auth.permission.admin.paths=/admin/*
quarkus.http.auth.permission.admin.policy=authenticated

# Gateway and pass-through routes remain open
quarkus.http.auth.permission.gateway.paths=/gateway/*
quarkus.http.auth.permission.gateway.policy=permit

# Health check and dev endpoints remain open
quarkus.http.auth.permission.health.paths=/q/*
quarkus.http.auth.permission.health.policy=permit

# Service pass-through (catch-all for /{serviceId}/*) - permit to allow public access
quarkus.http.auth.permission.passthrough.paths=/*
quarkus.http.auth.permission.passthrough.policy=permit

# =============================================================================
# Auth Key Storage Configuration
# =============================================================================

# Storage provider selection for API keys
# Options: memory (default, non-persistent), cassandra
# aussie.auth.storage.provider=cassandra

# Cassandra configuration for auth keys (falls back to aussie.storage.cassandra.* if not set)
# aussie.auth.storage.cassandra.contact-points=${CASSANDRA_CONTACT_POINTS:cassandra:9042}
# aussie.auth.storage.cassandra.datacenter=datacenter1
# aussie.auth.storage.cassandra.keyspace=aussie

# =============================================================================
# Auth Key Cache Configuration (Optional)
# =============================================================================

# Enable caching for API key validation (requires Redis)
aussie.auth.cache.enabled=false

# Cache provider selection
# aussie.auth.cache.provider=redis

# Cache TTL (ISO-8601 duration format)
aussie.auth.cache.ttl=PT5M

# =============================================================================
# Auth Key Encryption Configuration
# =============================================================================

# AES-256 encryption key for API key records at rest (Base64-encoded 256-bit key)
# Generate a key: openssl rand -base64 32
# SECURITY: Store this securely, e.g., in environment variable or secrets manager
# aussie.auth.encryption.key=${AUTH_ENCRYPTION_KEY}

# Key ID for encryption (used for key rotation)
aussie.auth.encryption.key-id=v1

# =============================================================================
# API Key Configuration
# =============================================================================

# Maximum TTL for API keys (ISO-8601 duration format)
# When set, API key creation will fail if requested TTL exceeds this value
# Examples: P90D (90 days), P365D (1 year), P7D (1 week)
# aussie.auth.api-keys.max-ttl=P365D

# =============================================================================
# Bootstrap Configuration
# =============================================================================

# Enable bootstrap mode for first-time admin setup
# When enabled, creates an admin API key from the provided AUSSIE_BOOTSTRAP_KEY
# Default: false (must be explicitly enabled)
aussie.bootstrap.enabled=${AUSSIE_BOOTSTRAP_ENABLED:false}

# Bootstrap key (REQUIRED when bootstrap is enabled)
# Must be at least 32 characters long
# Set via environment variable: AUSSIE_BOOTSTRAP_KEY
# aussie.bootstrap.key=${AUSSIE_BOOTSTRAP_KEY}

# Bootstrap key TTL (ISO-8601 duration format)
# Maximum allowed is PT24H (24 hours) - values exceeding this are capped
# Default: PT24H
aussie.bootstrap.ttl=${AUSSIE_BOOTSTRAP_TTL:PT24H}

# Recovery mode: allows bootstrap even when admin keys already exist
# WARNING: Only use for emergency recovery when all admin keys are lost
# Default: false
aussie.bootstrap.recovery-mode=${AUSSIE_BOOTSTRAP_RECOVERY_MODE:false}

# =============================================================================
# Session Configuration
# =============================================================================

# Enable/disable session management (default: true)
# When disabled, uses existing Authorization header flow
aussie.session.enabled=true

# Session TTL (ISO-8601 duration format)
aussie.session.ttl=PT8H

# Idle timeout - invalidate session after inactivity
aussie.session.idle-timeout=PT30M

# Enable sliding expiration (refresh TTL on activity)
aussie.session.sliding-expiration=true

# Session ID generation - max retries for collision
aussie.session.id-generation.max-retries=3

# Cookie configuration
aussie.session.cookie.name=aussie_session
aussie.session.cookie.path=/
# aussie.session.cookie.domain=example.com
aussie.session.cookie.secure=true
aussie.session.cookie.http-only=true
aussie.session.cookie.same-site=Lax

# Storage provider: redis, memory, or custom SPI name
aussie.session.storage.provider=redis
aussie.session.storage.redis.key-prefix=aussie:session:

# JWS token configuration for downstream services
aussie.session.jws.enabled=true
aussie.session.jws.ttl=PT5M
aussie.session.jws.issuer=aussie-gateway
# aussie.session.jws.audience=downstream-services
aussie.session.jws.include-claims=sub,email,name,roles

# Dev profile: use memory storage
%dev.aussie.session.storage.provider=memory
%dev.aussie.session.cookie.secure=false

# =============================================================================
# PKCE Configuration (Proof Key for Code Exchange)
# =============================================================================

# Enable/disable PKCE support (default: true)
aussie.auth.pkce.enabled=true

# Require PKCE for all authorization requests (default: true)
# When false, PKCE is optional but recommended
aussie.auth.pkce.required=true

# Challenge TTL - how long a PKCE challenge remains valid (default: 10 minutes)
aussie.auth.pkce.challenge-ttl=PT10M

# Storage provider: redis, memory (default: redis)
aussie.auth.pkce.storage.provider=redis
aussie.auth.pkce.storage.redis.key-prefix=aussie:pkce:

# Dev profile: use memory storage
%dev.aussie.auth.pkce.storage.provider=memory

# =============================================================================
# OIDC Token Exchange Configuration
# =============================================================================

# Enable OIDC token exchange (disabled by default)
# When enabled, Aussie can exchange authorization codes for tokens
aussie.auth.oidc.token-exchange.enabled=false

# Create Aussie session after successful token exchange (default: true)
# When true and an ID token is returned, creates a session from token claims
aussie.auth.oidc.token-exchange.create-session=true

# Token exchange provider: default, or custom SPI name
aussie.auth.oidc.token-exchange.provider=default

# IdP token endpoint URL
# aussie.auth.oidc.token-exchange.token-endpoint=${OIDC_TOKEN_ENDPOINT:}

# OAuth2 client ID
# aussie.auth.oidc.token-exchange.client-id=${OIDC_CLIENT_ID:}

# OAuth2 client secret (for confidential clients)
# aussie.auth.oidc.token-exchange.client-secret=${OIDC_CLIENT_SECRET:}

# Client authentication method: client_secret_basic or client_secret_post
aussie.auth.oidc.token-exchange.client-auth-method=client_secret_basic

# Scopes to request (space-separated)
aussie.auth.oidc.token-exchange.scopes=openid,profile,email

# HTTP timeout for token exchange requests
aussie.auth.oidc.token-exchange.timeout=PT10S

# Refresh token storage settings
aussie.auth.oidc.token-exchange.refresh-token.store=true
aussie.auth.oidc.token-exchange.refresh-token.default-ttl=PT168H
aussie.auth.oidc.token-exchange.refresh-token.key-prefix=aussie:oidc:refresh:

# Dev profile: enable token exchange with demo IdP
%dev.aussie.auth.oidc.token-exchange.enabled=true
%dev.aussie.auth.oidc.token-exchange.token-endpoint=http://localhost:3000/api/auth/oidc/token
%dev.aussie.auth.oidc.token-exchange.client-id=aussie-gateway
%dev.aussie.auth.oidc.token-exchange.client-secret=demo-secret
%dev.aussie.auth.oidc.token-exchange.create-session=false

# =============================================================================
# Route Authentication Configuration (OIDC Token Validation)
# =============================================================================

# Enable per-route authentication
aussie.auth.route-auth.enabled=false

# Demo app token provider (for development/testing)
# Uncomment to enable demo app login flow
# aussie.auth.route-auth.providers.demo.issuer=demo-app
# aussie.auth.route-auth.providers.demo.jwks-uri=http://demo:3000/.well-known/jwks.json
# aussie.auth.route-auth.providers.demo.audiences=aussie-gateway

# Dev profile: enable demo provider
# DEMO_APP_URL defaults to localhost:3000 for local dev, override to http://demo:3000 for Docker
%dev.aussie.auth.route-auth.enabled=true
%dev.aussie.auth.route-auth.providers.demo.issuer=demo-app
%dev.aussie.auth.route-auth.providers.demo.jwks-uri=${DEMO_APP_URL:http://localhost:3000}/.well-known/jwks.json
%dev.aussie.auth.route-auth.providers.demo.audiences=aussie-gateway

# =============================================================================
# Token TTL Configuration (Platform Teams)
# =============================================================================

# Default TTL for issued JWS tokens (ISO-8601 duration format)
aussie.auth.route-auth.jws.token-ttl=PT5M

# Maximum allowed TTL for any issued token
# Tokens with longer expiry from the IdP will be clamped to this value
# Platform teams can use this to enforce security policies
aussie.auth.route-auth.jws.max-token-ttl=PT24H

# Claims to forward from the original token to downstream services
aussie.auth.route-auth.jws.forwarded-claims=sub,email,name,groups,roles,effective_permissions

# JWS signing key for session tokens (PKCS#8 PEM format)
# Required for session-to-bearer-token conversion in route authentication
# Generate with: openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048
# Store the key in .env as AUSSIE_JWS_SIGNING_KEY.
# aussie.auth.route-auth.jws.signing-key=${AUSSIE_JWS_SIGNING_KEY}

# Dev profile: load signing key from environment variable
%dev.aussie.auth.route-auth.jws.signing-key=${AUSSIE_JWS_SIGNING_KEY}

# =============================================================================
# Signing Key Rotation Configuration
# =============================================================================

# Enable/disable automated key rotation (default: false)
# When disabled, uses the static key from aussie.auth.route-auth.jws.signing-key
aussie.auth.key-rotation.enabled=false

# Cron schedule for automatic key rotation
# Default: Quarterly (first day of Jan, Apr, Jul, Oct at midnight UTC)
# Format: Quartz cron syntax
aussie.auth.key-rotation.schedule=0 0 0 1 */3 ?

# How often to refresh the in-memory key cache from the repository
# Lower values = faster propagation, higher storage load
# Default: 5 minutes
aussie.auth.key-rotation.cache-refresh-interval=PT5M

# How often to run the retired key cleanup job
# Default: 1 hour
aussie.auth.key-rotation.cleanup-interval=PT1H

# Grace period before a new key becomes active
# During this time, the new key is in PENDING status
# Default: 24 hours
aussie.auth.key-rotation.grace-period=PT24H

# How long deprecated keys remain valid for verification
# Tokens signed with deprecated keys will still validate during this period
# Default: 7 days
aussie.auth.key-rotation.deprecation-period=P7D

# How long to retain retired keys before deletion
# After this period, keys are permanently deleted from storage
# Default: 30 days
aussie.auth.key-rotation.retention-period=P30D

# RSA key size in bits (2048 or 4096)
# Higher values = more security, slower signing/verification
aussie.auth.key-rotation.key-size=2048

# Key storage backend: config (default), vault, database
# config = in-memory storage with config-based initial key
aussie.auth.key-rotation.storage=config

# Vault configuration (when storage=vault)
# aussie.auth.key-rotation.vault.path=secret/aussie/signing-keys
# aussie.auth.key-rotation.vault.namespace=

# Dev profile: enable key rotation with short intervals for testing
%dev.aussie.auth.key-rotation.enabled=false
# %dev.aussie.auth.key-rotation.cache-refresh-interval=PT30S
# %dev.aussie.auth.key-rotation.grace-period=PT1M
# %dev.aussie.auth.key-rotation.deprecation-period=PT5M

# =============================================================================
# Token Revocation Configuration
# =============================================================================

# Enable/disable token revocation checks (default: true)
aussie.auth.revocation.enabled=true

# Enable user-level revocation checks (logout everywhere)
aussie.auth.revocation.check-user-revocation=true

# Skip revocation check for tokens expiring within this threshold
aussie.auth.revocation.check-threshold=PT30S

# Bloom filter configuration
aussie.auth.revocation.bloom-filter.enabled=true
aussie.auth.revocation.bloom-filter.expected-insertions=100000
aussie.auth.revocation.bloom-filter.false-positive-probability=0.001
aussie.auth.revocation.bloom-filter.rebuild-interval=PT1H

# Local cache configuration
aussie.auth.revocation.cache.enabled=true
aussie.auth.revocation.cache.max-size=10000
aussie.auth.revocation.cache.ttl=PT5M

# Pub/sub configuration for multi-instance synchronization
aussie.auth.revocation.pubsub.enabled=true
aussie.auth.revocation.pubsub.channel=aussie:revocation:events

# =============================================================================
# Authentication Rate Limiting (Brute Force Protection)
# =============================================================================

# Enable/disable authentication rate limiting (default: true)
aussie.auth.rate-limit.enabled=true

# Maximum failed authentication attempts before lockout
aussie.auth.rate-limit.max-failed-attempts=5

# Duration of lockout after max failed attempts (ISO-8601)
aussie.auth.rate-limit.lockout-duration=PT15M

# Time window for tracking failed attempts
aussie.auth.rate-limit.failed-attempt-window=PT1H

# Track failed attempts by IP address
aussie.auth.rate-limit.track-by-ip=true

# Track failed attempts by identifier (username, email, API key prefix)
aussie.auth.rate-limit.track-by-identifier=true

# Progressive lockout: multiplier for each subsequent lockout
aussie.auth.rate-limit.progressive-lockout-multiplier=1.5

# Maximum lockout duration (cap for progressive lockout)
aussie.auth.rate-limit.max-lockout-duration=PT24H

# Include rate limit headers in authentication error responses
aussie.auth.rate-limit.include-headers=true

# Test profile override: disable auth rate limiting during tests
%test.aussie.auth.rate-limit.enabled=false

# =============================================================================
# CORS Configuration
# =============================================================================

# Enable/disable CORS support for gateway requests
aussie.gateway.cors.enabled=true

# Global allowed origins (comma-separated, use * for any)
aussie.gateway.cors.allowed-origins=*

# Allowed HTTP methods
aussie.gateway.cors.allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD

# Allowed request headers
aussie.gateway.cors.allowed-headers=Content-Type,Authorization,X-Requested-With,Accept,Origin

# Headers exposed to the browser (optional - uncomment and configure as needed)
# aussie.gateway.cors.exposed-headers=X-Custom-Header

# Allow credentials (cookies, authorization headers)
aussie.gateway.cors.allow-credentials=true

# Max age for preflight cache (in seconds)
aussie.gateway.cors.max-age=3600

# Dev profile: allow all origins for local development
%dev.aussie.gateway.cors.allowed-origins=http://localhost:8080,http://localhost:3000,http://127.0.0.1:8080,http://127.0.0.1:3000

# =============================================================================
# Health Configuration
# =============================================================================

quarkus.smallrye-health.root-path=/q/health

# =============================================================================
# Telemetry Configuration (Disabled by Default)
# =============================================================================

# Master toggle for all telemetry features
# Platform teams must explicitly enable telemetry
aussie.telemetry.enabled=false

# Distributed tracing with OpenTelemetry
aussie.telemetry.tracing.enabled=false
aussie.telemetry.tracing.sampling-rate=1.0

# Metrics collection with Micrometer
aussie.telemetry.metrics.enabled=false

# Security monitoring for anomaly detection
aussie.telemetry.security.enabled=false
aussie.telemetry.security.rate-limit-window=PT1M
aussie.telemetry.security.rate-limit-threshold=1000
aussie.telemetry.security.dos-detection.enabled=true
aussie.telemetry.security.dos-detection.spike-threshold=5.0
aussie.telemetry.security.dos-detection.error-rate-threshold=0.5

# Traffic attribution for cost allocation
aussie.telemetry.attribution.enabled=false
aussie.telemetry.attribution.team-header=X-Team-ID
aussie.telemetry.attribution.tenant-header=X-Tenant-ID
aussie.telemetry.attribution.client-app-header=X-Client-Application

# Span attributes - control which attributes are included in traces
# High-cardinality attributes are disabled by default to reduce storage costs
aussie.telemetry.attributes.request-size=true
aussie.telemetry.attributes.response-size=true
aussie.telemetry.attributes.upstream-host=true
aussie.telemetry.attributes.upstream-port=true
aussie.telemetry.attributes.upstream-uri=false
aussie.telemetry.attributes.upstream-latency=true
aussie.telemetry.attributes.rate-limited=true
aussie.telemetry.attributes.rate-limit-remaining=true
aussie.telemetry.attributes.rate-limit-type=true
aussie.telemetry.attributes.rate-limit-retry-after=true

# =============================================================================
# OpenTelemetry Configuration (used when tracing enabled)
# =============================================================================

# Service identification
quarkus.application.name=aussie-gateway
quarkus.otel.service.name=${quarkus.application.name}
quarkus.otel.resource.attributes=deployment.environment=${AUSSIE_ENV:development}

# Tracing - controlled by aussie.telemetry.tracing.enabled
quarkus.otel.traces.enabled=${aussie.telemetry.tracing.enabled}
quarkus.otel.exporter.otlp.traces.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
quarkus.otel.exporter.otlp.traces.protocol=grpc

# Sampling strategy - use parent trace if present, otherwise sample based on ratio
quarkus.otel.traces.sampler=parentbased_traceidratio
quarkus.otel.traces.sampler.arg=${aussie.telemetry.tracing.sampling-rate}

# W3C Trace Context propagation (uses incoming traceparent if present)
quarkus.otel.propagators=tracecontext,baggage

# Span limits
quarkus.otel.span.attribute.count.limit=128
quarkus.otel.span.event.count.limit=128

# =============================================================================
# Micrometer Configuration (used when metrics enabled)
# =============================================================================

# Metrics - controlled by aussie.telemetry.metrics.enabled
quarkus.micrometer.enabled=${aussie.telemetry.metrics.enabled}
quarkus.micrometer.export.prometheus.enabled=${aussie.telemetry.metrics.enabled}
quarkus.micrometer.export.prometheus.path=/q/metrics

# Built-in metric binders
quarkus.micrometer.binder.http-client.enabled=true
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.jvm=true
quarkus.micrometer.binder.system=true
quarkus.micrometer.binder.vertx.enabled=true

# =============================================================================
# Dev Profile: Enable telemetry for local development
# =============================================================================
%dev.aussie.telemetry.enabled=true
%dev.aussie.telemetry.tracing.enabled=true
%dev.aussie.telemetry.metrics.enabled=true
%dev.aussie.telemetry.security.enabled=true
%dev.aussie.telemetry.attribution.enabled=true
%dev.aussie.telemetry.tracing.sampling-rate=1.0

# Dev profile: enable high-cardinality attributes for debugging
%dev.aussie.telemetry.attributes.upstream-uri=true

# =============================================================================
# Rate Limiting Configuration
# =============================================================================

# Master toggle for rate limiting
aussie.rate-limiting.enabled=true

# Algorithm selection - PLATFORM TEAMS ONLY
# Options: BUCKET, FIXED_WINDOW, SLIDING_WINDOW
# Set via environment variable: AUSSIE_RATE_LIMITING_ALGORITHM
aussie.rate-limiting.algorithm=BUCKET

# Platform-wide maximum requests per window
# Service/endpoint limits cannot exceed this value
# Set via: AUSSIE_RATE_LIMITING_PLATFORM_MAX_REQUESTS_PER_WINDOW
# Default: Long.MAX_VALUE (effectively unlimited)
# aussie.rate-limiting.platform-max-requests-per-window=10000

# Default rate limits for services without explicit configuration
aussie.rate-limiting.default-requests-per-window=100
aussie.rate-limiting.window-seconds=60
aussie.rate-limiting.burst-capacity=100

# Include X-RateLimit-* headers in responses
aussie.rate-limiting.include-headers=true

# WebSocket connection rate limiting
aussie.rate-limiting.websocket.connection.enabled=true
aussie.rate-limiting.websocket.connection.requests-per-window=10
aussie.rate-limiting.websocket.connection.window-seconds=60
aussie.rate-limiting.websocket.connection.burst-capacity=5

# WebSocket message rate limiting (per connection)
aussie.rate-limiting.websocket.message.enabled=true
aussie.rate-limiting.websocket.message.requests-per-window=100
aussie.rate-limiting.websocket.message.window-seconds=1
aussie.rate-limiting.websocket.message.burst-capacity=50

# Redis backend for distributed rate limiting
# When enabled and Redis is available, uses Redis for shared state
aussie.rate-limiting.redis.enabled=false

# Dev profile: more permissive limits for development
%dev.aussie.rate-limiting.default-requests-per-window=1000
%dev.aussie.rate-limiting.burst-capacity=500

# =============================================================================
# Local Cache Configuration (Multi-Instance Safety)
# =============================================================================

# TTL for service route cache (how long before re-checking storage)
# Lower values = faster cross-instance consistency, higher storage load
# Higher values = better performance, slower propagation
aussie.cache.local.service-routes-ttl=PT30S

# TTL for rate limit configuration cache
aussie.cache.local.rate-limit-config-ttl=PT30S

# Maximum entries in local caches (prevents memory issues)
aussie.cache.local.max-entries=10000

# Dev profile: shorter TTL for faster development iteration
%dev.aussie.cache.local.service-routes-ttl=PT5S
%dev.aussie.cache.local.rate-limit-config-ttl=PT5S
