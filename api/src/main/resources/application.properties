# Aussie Gateway Configuration

# Forwarding headers (RFC 7239 by default)
aussie.gateway.forwarding.use-rfc7239=true

# Request size limits
aussie.gateway.limits.max-body-size=10485760
aussie.gateway.limits.max-header-size=8192
aussie.gateway.limits.max-total-headers-size=32768

# Global access control for private endpoints (uncomment and configure as needed)
# aussie.gateway.access-control.allowed-ips=10.0.0.0/8,192.168.0.0/16,127.0.0.1
# aussie.gateway.access-control.allowed-domains=internal.example.com
# aussie.gateway.access-control.allowed-subdomains=*.internal.example.com

# =============================================================================
# Storage Configuration
# =============================================================================

# Repository provider selection
# Options: memory (default, non-persistent), cassandra
# Default uses highest priority available provider
# aussie.storage.repository.provider=cassandra

# =============================================================================
# Cache Configuration (Optional)
# =============================================================================

# Enable caching (requires Redis to be available)
aussie.storage.cache.enabled=false

# Cache provider selection (only used if cache.enabled=true)
# Options: redis
# aussie.storage.cache.provider=redis

# Cache TTL in ISO-8601 duration format
aussie.storage.cache.ttl=PT15M

# =============================================================================
# Cassandra Configuration
# =============================================================================

# Contact points (comma-separated host:port pairs)
aussie.storage.cassandra.contact-points=${CASSANDRA_CONTACT_POINTS:cassandra:9042}

# Local datacenter name
aussie.storage.cassandra.datacenter=datacenter1

# Keyspace name
aussie.storage.cassandra.keyspace=aussie

# Run database migrations on startup (default: false)
# When enabled, applies any pending CQL migrations from db/cassandra/
aussie.storage.cassandra.run-migrations=${CASSANDRA_RUN_MIGRATIONS:false}

# Authentication (uncomment for production)
# aussie.storage.cassandra.username=${CASSANDRA_USERNAME}
# aussie.storage.cassandra.password=${CASSANDRA_PASSWORD}

# =============================================================================
# Quarkus Redis Configuration
# =============================================================================

quarkus.redis.hosts=redis://localhost:6379

# Authentication (uncomment for production)
# quarkus.redis.password=${REDIS_PASSWORD}

# Health check - disabled by default (enable when Redis is available)
quarkus.redis.health.enabled=false

# =============================================================================
# Authentication Configuration
# =============================================================================

# Enable/disable authentication (default: true)
aussie.auth.enabled=true

# Only require auth for admin paths (default: true)
# When true, /admin/* requires authentication but /gateway/* and /{serviceId}/* remain open
aussie.auth.admin-paths-only=true

# DANGEROUS: Disable authentication entirely for development
# WARNING: Never enable this in production!
aussie.auth.dangerous-noop=false

# Dev profile: enable dangerous-noop for local development
%dev.aussie.auth.dangerous-noop=true

# JWT authentication (for OAuth2/OIDC setups)
# Uncomment and configure for JWT support
# aussie.auth.jwt.issuer=https://auth.example.com
# aussie.auth.jwt.audience=aussie-api
# aussie.auth.jwt.jwks-uri=https://auth.example.com/.well-known/jwks.json

# =============================================================================
# Quarkus Security Path Permissions
# =============================================================================

# Admin endpoints require authentication (enforced by @RolesAllowed on endpoints)
quarkus.http.auth.permission.admin.paths=/admin/*
quarkus.http.auth.permission.admin.policy=authenticated

# Gateway and pass-through routes remain open
quarkus.http.auth.permission.gateway.paths=/gateway/*
quarkus.http.auth.permission.gateway.policy=permit

# Health check and dev endpoints remain open
quarkus.http.auth.permission.health.paths=/q/*
quarkus.http.auth.permission.health.policy=permit

# Service pass-through (catch-all for /{serviceId}/*) - permit to allow public access
quarkus.http.auth.permission.passthrough.paths=/*
quarkus.http.auth.permission.passthrough.policy=permit

# =============================================================================
# Auth Key Storage Configuration
# =============================================================================

# Storage provider selection for API keys
# Options: memory (default, non-persistent), cassandra
# aussie.auth.storage.provider=cassandra

# Cassandra configuration for auth keys (falls back to aussie.storage.cassandra.* if not set)
# aussie.auth.storage.cassandra.contact-points=${CASSANDRA_CONTACT_POINTS:cassandra:9042}
# aussie.auth.storage.cassandra.datacenter=datacenter1
# aussie.auth.storage.cassandra.keyspace=aussie

# =============================================================================
# Auth Key Cache Configuration (Optional)
# =============================================================================

# Enable caching for API key validation (requires Redis)
aussie.auth.cache.enabled=false

# Cache provider selection
# aussie.auth.cache.provider=redis

# Cache TTL (ISO-8601 duration format)
aussie.auth.cache.ttl=PT5M

# =============================================================================
# Auth Key Encryption Configuration
# =============================================================================

# AES-256 encryption key for API key records at rest (Base64-encoded 256-bit key)
# Generate a key: openssl rand -base64 32
# SECURITY: Store this securely, e.g., in environment variable or secrets manager
# aussie.auth.encryption.key=${AUTH_ENCRYPTION_KEY}

# Key ID for encryption (used for key rotation)
aussie.auth.encryption.key-id=v1

# =============================================================================
# API Key Configuration
# =============================================================================

# Maximum TTL for API keys (ISO-8601 duration format)
# When set, API key creation will fail if requested TTL exceeds this value
# Examples: P90D (90 days), P365D (1 year), P7D (1 week)
# aussie.auth.api-keys.max-ttl=P365D

# =============================================================================
# Bootstrap Configuration
# =============================================================================

# Enable bootstrap mode for first-time admin setup
# When enabled, creates an admin API key from the provided AUSSIE_BOOTSTRAP_KEY
# Default: false (must be explicitly enabled)
aussie.bootstrap.enabled=${AUSSIE_BOOTSTRAP_ENABLED:false}

# Bootstrap key (REQUIRED when bootstrap is enabled)
# Must be at least 32 characters long
# Set via environment variable: AUSSIE_BOOTSTRAP_KEY
# aussie.bootstrap.key=${AUSSIE_BOOTSTRAP_KEY}

# Bootstrap key TTL (ISO-8601 duration format)
# Maximum allowed is PT24H (24 hours) - values exceeding this are capped
# Default: PT24H
aussie.bootstrap.ttl=${AUSSIE_BOOTSTRAP_TTL:PT24H}

# Recovery mode: allows bootstrap even when admin keys already exist
# WARNING: Only use for emergency recovery when all admin keys are lost
# Default: false
aussie.bootstrap.recovery-mode=${AUSSIE_BOOTSTRAP_RECOVERY_MODE:false}

# =============================================================================
# Session Configuration
# =============================================================================

# Enable/disable session management (default: true)
# When disabled, uses existing Authorization header flow
aussie.session.enabled=true

# Session TTL (ISO-8601 duration format)
aussie.session.ttl=PT8H

# Idle timeout - invalidate session after inactivity
aussie.session.idle-timeout=PT30M

# Enable sliding expiration (refresh TTL on activity)
aussie.session.sliding-expiration=true

# Session ID generation - max retries for collision
aussie.session.id-generation.max-retries=3

# Cookie configuration
aussie.session.cookie.name=aussie_session
aussie.session.cookie.path=/
# aussie.session.cookie.domain=example.com
aussie.session.cookie.secure=true
aussie.session.cookie.http-only=true
aussie.session.cookie.same-site=Lax

# Storage provider: redis, memory, or custom SPI name
aussie.session.storage.provider=redis
aussie.session.storage.redis.key-prefix=aussie:session:

# JWS token configuration for downstream services
aussie.session.jws.enabled=true
aussie.session.jws.ttl=PT5M
aussie.session.jws.issuer=aussie-gateway
# aussie.session.jws.audience=downstream-services
aussie.session.jws.include-claims=sub,email,name,roles

# Dev profile: use memory storage
%dev.aussie.session.storage.provider=memory
%dev.aussie.session.cookie.secure=false

# =============================================================================
# Route Authentication Configuration (OIDC Token Validation)
# =============================================================================

# Enable per-route authentication
aussie.auth.route-auth.enabled=false

# Demo app token provider (for development/testing)
# Uncomment to enable demo app login flow
# aussie.auth.route-auth.providers.demo.issuer=demo-app
# aussie.auth.route-auth.providers.demo.jwks-uri=http://demo:3000/.well-known/jwks.json
# aussie.auth.route-auth.providers.demo.audiences=aussie-gateway

# Dev profile: enable demo provider
%dev.aussie.auth.route-auth.enabled=true
%dev.aussie.auth.route-auth.providers.demo.issuer=demo-app
%dev.aussie.auth.route-auth.providers.demo.jwks-uri=http://demo:3000/.well-known/jwks.json
%dev.aussie.auth.route-auth.providers.demo.audiences=aussie-gateway

# JWS signing key for session tokens (PKCS#8 PEM format)
# Required for session-to-bearer-token conversion in route authentication
# Generate with: openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048
# Store the key in .env as AUSSIE_JWS_SIGNING_KEY (see .env for example)
# aussie.auth.route-auth.jws.signing-key=${AUSSIE_JWS_SIGNING_KEY}

# Dev profile: load signing key from environment variable
%dev.aussie.auth.route-auth.jws.signing-key=${AUSSIE_JWS_SIGNING_KEY}

# =============================================================================
# CORS Configuration
# =============================================================================

# Enable/disable CORS support for gateway requests
aussie.gateway.cors.enabled=true

# Global allowed origins (comma-separated, use * for any)
aussie.gateway.cors.allowed-origins=*

# Allowed HTTP methods
aussie.gateway.cors.allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS,HEAD

# Allowed request headers
aussie.gateway.cors.allowed-headers=Content-Type,Authorization,X-Requested-With,Accept,Origin

# Headers exposed to the browser (optional - uncomment and configure as needed)
# aussie.gateway.cors.exposed-headers=X-Custom-Header

# Allow credentials (cookies, authorization headers)
aussie.gateway.cors.allow-credentials=true

# Max age for preflight cache (in seconds)
aussie.gateway.cors.max-age=3600

# Dev profile: allow all origins for local development
%dev.aussie.gateway.cors.allowed-origins=http://localhost:8080,http://localhost:3000,http://127.0.0.1:8080,http://127.0.0.1:3000

# =============================================================================
# Health Configuration
# =============================================================================

quarkus.smallrye-health.root-path=/q/health

# =============================================================================
# Telemetry Configuration (Disabled by Default)
# =============================================================================

# Master toggle for all telemetry features
# Platform teams must explicitly enable telemetry
aussie.telemetry.enabled=false

# Distributed tracing with OpenTelemetry
aussie.telemetry.tracing.enabled=false
aussie.telemetry.tracing.sampling-rate=1.0

# Metrics collection with Micrometer
aussie.telemetry.metrics.enabled=false
aussie.telemetry.metrics.proxy-latency-buckets=5,10,25,50,100,250,500,1000,2500,5000,10000
aussie.telemetry.metrics.request-size-buckets=100,1000,10000,100000,1000000

# Security monitoring for anomaly detection
aussie.telemetry.security.enabled=false
aussie.telemetry.security.rate-limit-window=PT1M
aussie.telemetry.security.rate-limit-threshold=1000
aussie.telemetry.security.dos-detection.enabled=true
aussie.telemetry.security.dos-detection.spike-threshold=5.0
aussie.telemetry.security.dos-detection.error-rate-threshold=0.5

# Traffic attribution for cost allocation
aussie.telemetry.attribution.enabled=false
aussie.telemetry.attribution.include-headers=false
aussie.telemetry.attribution.team-header=X-Team-ID
aussie.telemetry.attribution.tenant-header=X-Tenant-ID
aussie.telemetry.attribution.client-app-header=X-Client-Application

# =============================================================================
# OpenTelemetry Configuration (used when tracing enabled)
# =============================================================================

# Service identification
quarkus.application.name=aussie-gateway
quarkus.otel.service.name=${quarkus.application.name}
quarkus.otel.resource.attributes=deployment.environment=${AUSSIE_ENV:development}

# Tracing - controlled by aussie.telemetry.tracing.enabled
quarkus.otel.traces.enabled=${aussie.telemetry.tracing.enabled}
quarkus.otel.exporter.otlp.traces.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
quarkus.otel.exporter.otlp.traces.protocol=grpc

# Sampling strategy - use parent trace if present, otherwise sample based on ratio
quarkus.otel.traces.sampler=parentbased_traceidratio
quarkus.otel.traces.sampler.arg=${aussie.telemetry.tracing.sampling-rate}

# W3C Trace Context propagation (uses incoming traceparent if present)
quarkus.otel.propagators=tracecontext,baggage

# Span limits
quarkus.otel.span.attribute.count.limit=128
quarkus.otel.span.event.count.limit=128

# =============================================================================
# Micrometer Configuration (used when metrics enabled)
# =============================================================================

# Metrics - controlled by aussie.telemetry.metrics.enabled
quarkus.micrometer.enabled=${aussie.telemetry.metrics.enabled}
quarkus.micrometer.export.prometheus.enabled=${aussie.telemetry.metrics.enabled}
quarkus.micrometer.export.prometheus.path=/q/metrics

# Built-in metric binders
quarkus.micrometer.binder.http-client.enabled=true
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.binder.jvm=true
quarkus.micrometer.binder.system=true
quarkus.micrometer.binder.vertx.enabled=true

# =============================================================================
# Dev Profile: Enable telemetry for local development
# =============================================================================
%dev.aussie.telemetry.enabled=true
%dev.aussie.telemetry.tracing.enabled=true
%dev.aussie.telemetry.metrics.enabled=true
%dev.aussie.telemetry.security.enabled=true
%dev.aussie.telemetry.attribution.enabled=true
%dev.aussie.telemetry.tracing.sampling-rate=1.0
